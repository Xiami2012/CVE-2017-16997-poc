#!/bin/bash

unset NORMAL_USER
if [ ${EUID:--1} -eq -1 ]; then
	echo "INTERNAL ERROR"
	exit 1
elif [ ${EUID} -eq 0 ]; then
	NORMAL_USER=`awk -F: '$3 != "0"{print $1; exit}' /etc/passwd`
	if [ -z "$NORMAL_USER" ]; then
		echo "What?! There's only one user in your system??????"
		exit 1
	fi
fi

make clean
make || exit $?

if ! build/test; then
	echo -e "\n\e[33mYour dynamic linker/loader do not support \$ORIGIN. Therefore you are safe.\e[0m"
	exit 0
fi

if [ -z "$NORMAL_USER" ]; then
	echo "sudo to change owner and set suid"
	sudo chown root build/test || exit 1
	sudo chmod u+s build/test
else
	chown "${NORMAL_USER}" build/test
	chmod u+s build/test
fi

build/test
ret=$?
if [ $ret -eq 0 ]; then
	echo -e "\n\e[32mYou are safe!\e[0m"
	exit 0
elif [ $ret -eq 127 ]; then
	echo -e "\n\e[33mFailed to run test. Whatever, you are safe.\e[0m"
	exit 0
else
	echo -e "\n\e[31mYour glibc is VULNERABLE to CVE-2017-16997!\e[0m"

	echo "Scanning PATH..."
	IFS=: read -ra paths <<<"$PATH"
	if [ ${EUID:--1} -eq 0 ]; then
		find "${paths[@]}" -perm -4100 -exec readelf -d {} \; 2>/dev/null | grep -qEe 'R(UN)?PATH.*$ORIGIN'
	else
		sudo find "${paths[@]}" -perm -4100 -exec readelf -d {} \; 2>/dev/null | grep -qEe 'R(UN)?PATH.*$ORIGIN'
	fi
	if [ $? -eq 0 ]; then
		echo -e "\e[31mYou have such suid programs in your PATH\e[0m"
	else
		echo -e "\e[32mYour system seems to be unaffected (no such programs in PATH)\e[0m"
	fi
fi
